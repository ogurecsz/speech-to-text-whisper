<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —Å Whisper</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="light-theme"> <div class="container">
    <div class="theme-switcher">
      <button id="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <i class="fas fa-moon"></i> </button>
    </div>

    <h1>üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–∞ –±–∞–∑–µ Whisper</h1>
    <p class="description">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª, –∑–∞–ø–∏—à–∏—Ç–µ —Ä–µ—á—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –∏ –æ–Ω –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø—Ä—è–º–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>

    <div class="input-section">
      <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="audio-file-input" accept="audio/*" class="file-input">
      <button id="transcribe-file-button" class="action-button">–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ñ–∞–π–ª</button>
    </div>

    <div class="or-separator">–ò–õ–ò</div>

    <div class="input-section">
      <h3>–ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ—á—å</h3>
      <div class="record-controls">
        <button id="record-start-button" class="action-button record-button start-record-btn"><i class="fas fa-microphone"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="record-stop-button" class="action-button record-button stop-record-btn" disabled><i class="fas fa-stop-circle"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        <div id="recording-indicator" class="recording-indicator">
          <div class="pulse-circle"></div>
          <span class="recording-text">–ó–∞–ø–∏—Å—å...</span>
        </div>
      </div>
    </div>
    
    <div class="status-box">
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="status">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è...</span></p>
    </div>
    
    <div class="result-box">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
        <p id="result-text"></p>
    </div>
  </div>

  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const fileInput = document.getElementById('audio-file-input');
    const transcribeFileButton = document.getElementById('transcribe-file-button'); // –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ñ–∞–π–ª–∞
    const recordStartButton = document.getElementById('record-start-button');
    const recordStopButton = document.getElementById('record-stop-button');
    const recordingIndicator = document.getElementById('recording-indicator');
    const statusElement = document.getElementById('status');
    const resultTextElement = document.getElementById('result-text');

    let recognizer;
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    // --- –§—É–Ω–∫—Ü–∏–∏ UI –∏ —Ç–µ–º—ã ---
    function updateStatus(text) {
      statusElement.textContent = text;
      console.log(text);
    }

    function toggleTheme() {
      body.classList.toggle('light-theme');
      body.classList.toggle('dark-theme');
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä —Ç–µ–º—ã –≤ localStorage
      const currentTheme = body.classList.contains('dark-theme') ? 'dark' : 'light';
      localStorage.setItem('theme', currentTheme);
      updateThemeIcon(currentTheme);
    }

    function updateThemeIcon(theme) {
      if (theme === 'dark') {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; // –ò–∫–æ–Ω–∫–∞ –°–æ–ª–Ω—Ü–∞ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã
        themeToggle.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>'; // –ò–∫–æ–Ω–∫–∞ –õ—É–Ω—ã –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
        themeToggle.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ç—ë–º–Ω—É—é —Ç–µ–º—É';
      }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ---
    async function initializeRecognizer() {
      try {
        updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏... (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'whisper-tiny' –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏, –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –Ω–∞ 'whisper-base'
        recognizer = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny'); 
        updateStatus('–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–ø–∏—Å—å.');
        transcribeFileButton.disabled = false;
        recordStartButton.disabled = false;
      } catch (error) {
        updateStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏.');
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—è:', error);
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
        transcribeFileButton.disabled = true;
        recordStartButton.disabled = true;
        recordStopButton.disabled = true;
      }
    }

    async function transcribeAudio(audioFileOrBlob) {
      if (!recognizer) {
        updateStatus('–û—à–∏–±–∫–∞: —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.');
        return;
      }

      const audioUrl = URL.createObjectURL(audioFileOrBlob);

      try {
        transcribeFileButton.disabled = true;
        recordStartButton.disabled = true;
        recordStopButton.disabled = true;
        recordingIndicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
        resultTextElement.textContent = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        updateStatus(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...`);
        
        const output = await recognizer(audioUrl, {
            chunk_length_s: 30,
            stride_length_s: 5,
            language: 'russian',
            task: 'transcribe',
        });

        updateStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
        resultTextElement.textContent = output.text;
      } catch (error) {
        updateStatus('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.');
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏:', error);
      } finally {
        transcribeFileButton.disabled = false;
        if (!mediaRecorder || mediaRecorder.state === 'inactive') { // –ù–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ (–∏–¥–µ—Ç –∑–∞–ø–∏—Å—å)
          recordStartButton.disabled = false;
        }
        URL.revokeObjectURL(audioUrl); // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
      }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ ---
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å 'audio/mp3' –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
          updateStatus('–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ...');
          transcribeAudio(audioBlob);
          stream.getTracks().forEach(track => track.stop()); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        };

        mediaRecorder.start();
        updateStatus('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å...');
        recordStartButton.disabled = true;
        recordStopButton.disabled = false;
        recordingIndicator.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
        resultTextElement.textContent = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      } catch (error) {
        updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏–ª–∏ –∑–∞–ø–∏—Å–∏.');
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ:', error);
        recordStartButton.disabled = false;
        recordStopButton.disabled = true;
        recordingIndicator.style.display = 'none';
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        updateStatus('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏...');
        recordStopButton.disabled = true;
        recordingIndicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
      }
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    themeToggle.addEventListener('click', toggleTheme);
    transcribeFileButton.addEventListener('click', () => {
      if (fileInput.files.length > 0) {
        transcribeAudio(fileInput.files[0]);
      } else {
        updateStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
      }
    });
    recordStartButton.addEventListener('click', startRecording);
    recordStopButton.addEventListener('click', stopRecording);

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
    transcribeFileButton.disabled = true;
    recordStartButton.disabled = true;
    recordStopButton.disabled = true;
    recordingIndicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      body.classList.remove('light-theme');
      body.classList.add('dark-theme');
    } else {
      body.classList.add('light-theme'); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
    updateThemeIcon(savedTheme || 'light'); // –û–±–Ω–æ–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

    initializeRecognizer();
  </script>
</body>
</html>
